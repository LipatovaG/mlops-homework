# Step 2: Function Calling с Pose Visualization

## Описание

Интеграция LLM с API визуализации поз человека через function calling. Создаём агента, который может генерировать позы по текстовому описанию и визуализировать их как изображения.

## Архитектура

```
┌─────────────┐      ┌──────────────┐      ┌─────────────────┐
│   User      │─────▶│ Pose         │─────▶│  vLLM Server    │
│             │      │ Agent        │      │  (LLM)          │
└─────────────┘      └──────────────┘      └─────────────────┘
                            │                        │
                            │                   Tool Calls
                            ▼                        │
                     ┌──────────────┐               │
                     │ Pose         │◀──────────────┘
                     │ Visualization│
                     │ API          │
                     └──────────────┘
                            │
                            ▼
                      PNG Image (base64)
```

## Компоненты

### 1. Pose Visualization API (`src/pose_api.py`)

FastAPI сервис для визуализации поз:

**Endpoints:**
- `POST /visualize` - визуализировать позу и получить изображение
- `POST /analyze` - проанализировать позу (действие, симметрия, баланс)
- `GET /examples` - получить примеры поз
- `POST /save_pose` - сохранить позу в галерею
- `GET /gallery` - получить галерею сохранённых поз

**Формат данных:**
```json
{
  "Torso": [0, 0],     // Туловище - центр координат
  "Head": [0, 60],     // Голова
  "RH": [50, 35],      // Right Hand - правая кисть
  "LH": [-50, 35],     // Left Hand - левая кисть
  "RK": [15, -50],     // Right Knee - правое колено
  "LK": [-15, -50]     // Left Knee - левое колено
}
```

**Анализ позы:**
- Определение действия (прыжок, T-поза, приветствие, и т.д.)
- Оценка симметрии (0-1)
- Оценка баланса (0-1)
- Рекомендации по улучшению

### 2. Pose Agent (`src/pose_agent.py`)

LLM агент с function calling:

**Возможности:**
- Генерация координат поз из текстового описания
- Визуализация поз как PNG изображений
- Анализ поз
- Работа с галереей поз

**Инструменты (tools):**
- `visualize_pose` - создать и визуализировать позу
- `analyze_pose` - проанализировать позу
- `get_pose_examples` - получить примеры
- `save_pose` - сохранить в галерею
- `get_gallery` - просмотр галереи

## Структура

```
step2_function_calling/
├── src/
│   ├── __init__.py
│   ├── pose_api.py           # API визуализации поз
│   └── pose_agent.py         # LLM агент с function calling
├── notebooks/
│   └── pose_demo.ipynb       # Интерактивный демо
├── docker-compose.yml        # vLLM + Pose API
├── Dockerfile.pose           # Docker для Pose API
├── test_agent.py            # Тестовый скрипт
├── test_imports.py          # Проверка импортов
├── pyproject.toml           # Poetry зависимости
├── Makefile                 # Команды автоматизации
└── README.md
```

## Установка

```bash
# Установка зависимостей
make install

# Или вручную
poetry install
```

## Запуск

### 1. Запуск всех сервисов

```bash
# Запуск vLLM и Pose API
make start-all
```

Это запустит:
- vLLM сервер на `http://localhost:8000`
- Pose Visualization API на `http://localhost:8001`

**Важно**: Первый запуск займёт несколько минут для загрузки модели.

### 2. Проверка логов

```bash
# Логи vLLM
make logs-vllm

# Логи Pose API
make logs-pose
```

### 3. Быстрое тестирование (БЕЗ vLLM)

Для быстрой проверки Pose API можно протестировать БЕЗ запуска vLLM:

```bash
# Запустить только Pose API
docker-compose up -d --build pose_api

# Протестировать API напрямую
make test-api
```

Изображения сохранятся в `test_output_api/`

### 4. Полное тестирование агента (с vLLM)

**Требует GPU или займёт много времени на CPU!**

```bash
# Запустить все сервисы
make start-all

# Тестировать агента
make test
```

### 5. Интерактивный notebook

```bash
make notebook
```

Откройте `notebooks/pose_demo.ipynb` для интерактивной работы.

## Использование

### Python API

```python
from src.pose_agent import PoseAgent

# Инициализация агента
agent = PoseAgent(
    llm_base_url="http://localhost:8000/v1",
    pose_api_url="http://localhost:8001"
)

# Генерация позы по описанию
result = agent.chat("Создай T-позу - человек с руками в стороны")
print(result['text'])  # Текстовый ответ

# Сохранение изображения
if result['image']:
    import base64
    img_data = base64.b64decode(result['image'])
    with open('pose.png', 'wb') as f:
        f.write(img_data)
```

### Примеры запросов

**Создание поз:**
```
"Создай T-позу"
"Сделай позу прыжка"
"Покажи позу приветствия"
"Создай позу йоги - медитация"
"Сделай динамичную позу танцора"
```

**Анализ:**
```
"Проанализируй эту позу"
"Какая это поза?"
"Насколько симметрична эта поза?"
```

**Работа с галереей:**
```
"Покажи примеры поз"
"Сохрани эту позу как 'моя_поза'"
"Что у нас в галерее?"
```

## Function Calling - как это работает

1. **Пользователь**: "Создай позу прыжка"
2. **LLM**: Анализирует запрос, понимает, что нужна поза с руками вверх и ногами вместе
3. **LLM**: Генерирует координаты:
   ```json
   {
     "Torso": [0, 0],
     "Head": [0, 60],
     "RH": [25, 55],
     "LH": [-25, 55],
     "RK": [10, -30],
     "LK": [-10, -30]
   }
   ```
4. **Agent**: Вызывает `visualize_pose()` с этими координатами
5. **Pose API**: Рисует человечка, анализирует позу, возвращает PNG (base64)
6. **LLM**: Формирует естественный ответ на русском языке
7. **Пользователь**: Получает текст + изображение

## Особенности визуализации

### Система координат
- **Torso** в центре (0, 0)
- **Y ось**: вверх положительная, вниз отрицательная
- **X ось**: вправо положительная, влево отрицательная
- **Голова**: обычно 50-70 пикселей над торсом
- **Колени**: обычно 40-60 пикселей ниже торса

### Цветовая схема
- **Туловище/голова**: Синий (#4A90E2) + Золотой (#FFD700)
- **Правая сторона**: Красный (#E74C3C)
- **Левая сторона**: Зелёный (#2ECC71)

### Анализ поз
API автоматически определяет:
- Тип действия (прыжок, T-поза, приветствие, и т.д.)
- Симметричность (0.0-1.0)
- Баланс/устойчивость (0.0-1.0)
- Рекомендации по улучшению

## Примеры поз

API предоставляет готовые примеры:

| Поза | Описание |
|------|----------|
| **T-поза** | Руки в стороны, ноги вместе |
| **Прыжок** | Руки вверх, ноги близко |
| **Приветствие** | Одна рука вверх |
| **Медитация** | Руки внизу, ноги расставлены |
| **Звезда** | Руки и ноги широко расставлены |

## Остановка сервисов

```bash
# Остановить все сервисы
make stop

# Полная очистка
make clean
```

## Расширение функциональности

Вы можете добавить:

1. **Новые части тела**:
   - Локти, плечи, бёдра
   - Пальцы, стопы
   - Spine points

2. **Анимация**:
   - Интерполяция между позами
   - Генерация последовательности движений

3. **3D визуализация**:
   - Добавить Z координату
   - Использовать Three.js или matplotlib 3D

4. **Датасеты**:
   - Генерация тренировочных данных
   - Аугментация поз
   - Экспорт в форматы для обучения

5. **Валидация**:
   - Физические ограничения (суставы)
   - Проверка реалистичности
   - Collision detection

## Образовательная ценность

Студенты изучат:
- **LLM + Структурированные данные**: Генерация JSON из текста
- **Function calling**: Автоматический выбор функций
- **Визуализация**: Создание изображений с matplotlib
- **API дизайн**: RESTful API с валидацией
- **Base64 encoding**: Передача изображений через JSON
- **Анализ данных**: Вычисление метрик из координат

## Troubleshooting

### Pose API не отвечает
```bash
# Проверьте логи
make logs-pose

# Перезапустите сервис
docker-compose restart pose_api
```

### Изображения не генерируются
- Убедитесь, что matplotlib установлен
- Проверьте, что координаты в разумных пределах (±300)

### LLM генерирует неправильные координаты
- Это нормально для маленьких моделей
- Попробуйте более детальные описания
- Используйте примеры в промпте

## Дополнительная информация

- [Matplotlib Documentation](https://matplotlib.org/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [OpenAI Function Calling](https://platform.openai.com/docs/guides/function-calling)
- [Human Pose Estimation](https://paperswithcode.com/task/pose-estimation)
